name: Monitoring Nightly

on:
  schedule:
    - cron: "17 3 * * *" # 03:17 UTC daily (~9:17 PM CT previous day during DST)
  workflow_dispatch:

concurrency:
  group: monitoring-nightly-${{ github.ref }}
  cancel-in-progress: true

jobs:
  nightly:
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Versions
        run: |
          docker --version
          docker compose version || true
          pwsh --version

      - name: Start stack
        working-directory: monitoring
        run: |
          docker compose pull || true
          docker compose up -d prometheus alertmanager grafana crm-api postgres-crm

      - name: Wait for Prometheus
        run: |
          for i in {1..90}; do
            if curl -fsS http://localhost:9090/-/ready >/dev/null; then exit 0; fi
            echo "Waiting for Prometheus... ($i/90)"; sleep 2
          done; exit 1

      - name: Wait for Grafana
        run: |
          for i in {1..90}; do
            if curl -fsS http://localhost:3000/api/health >/dev/null; then exit 0; fi
            echo "Waiting for Grafana... ($i/90)"; sleep 2
          done; exit 1

      - name: Wait for Alertmanager
        run: |
          for i in {1..90}; do
            if curl -fsS http://localhost:9093/api/v2/status >/dev/null; then exit 0; fi
            echo "Waiting for Alertmanager... ($i/90)"; sleep 2
          done; exit 1

      - name: Wait for CRM API
        run: |
          for i in {1..90}; do
            if curl -fsS http://localhost:8089/metrics >/dev/null 2>&1; then exit 0; fi
            echo "Waiting for CRM API... ($i/90)"; sleep 2
          done; exit 1

      - name: Synthetic bump to keep counters fresh
        shell: bash
        run: |
          docker exec crm-api python -c "
          from crm.metrics import CRM_INVOICES_PAID, CRM_INVOICE_PAYMENTS_CENTS
          from crm.routers.qbo import QBO_INVOICES_TOTAL
          org='1'
          QBO_INVOICES_TOTAL.labels(org_id=org).inc(1)
          CRM_INVOICES_PAID.labels(org_id=org).inc(1)
          CRM_INVOICE_PAYMENTS_CENTS.labels(org_id=org).inc(12345)
          print('Synthetic bump done')
          " || true

      - name: Wait for Prometheus to scrape metrics
        run: |
          echo "Waiting 30 seconds for Prometheus to scrape CRM metrics..."
          sleep 30

      - name: Run smoke test (with Slack if secret exists)
        shell: pwsh
        run: |
          if ("${{ env.SLACK_WEBHOOK_URL }}".Length -gt 0) {
            pwsh -ExecutionPolicy Bypass -File ./scripts/test_monitoring_stack.ps1 -FireSlack
          } else {
            pwsh -ExecutionPolicy Bypass -File ./scripts/test_monitoring_stack.ps1
          }

      - name: Brief Prom/Alert status
        if: always()
        run: |
          echo "=== Prometheus Rule Groups ==="
          curl -s http://localhost:9090/api/v1/rules | jq '.data.groups[] | {name:.name, rules:(.rules|length)}' || true
          echo ""
          echo "=== Active Alerts ==="
          curl -s http://localhost:9090/api/v1/alerts | jq '.data.alerts[] | {name:.labels.alertname, state:.state, value:.value}' || true
          echo ""
          echo "=== CRM Scrape Targets ==="
          curl -s http://localhost:9090/api/v1/targets | jq '.data.activeTargets[] | select(.labels.job | contains("crm")) | {job:.labels.job, health:.health, lastScrape:.lastScrape}' || true

      - name: Collect logs on failure
        if: failure()
        working-directory: monitoring
        run: |
          mkdir -p artifacts
          docker compose logs --no-color prometheus   > artifacts/prometheus.log  2>&1 || true
          docker compose logs --no-color alertmanager > artifacts/alertmanager.log 2>&1 || true
          docker compose logs --no-color grafana      > artifacts/grafana.log     2>&1 || true
          docker compose logs --no-color crm-api      > artifacts/crm-api.log     2>&1 || true
          docker compose logs --no-color postgres-crm > artifacts/postgres-crm.log 2>&1 || true

      - name: Upload logs (failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-nightly-logs
          path: monitoring/artifacts

      - name: Tear down
        if: always()
        working-directory: monitoring
        run: docker compose down -v
