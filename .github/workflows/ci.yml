name: customer-ops CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: customer-ops-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint (ruff + pyright)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: pods/customer_ops
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff pyright

      - name: Ruff check (annotate)
        run: ruff check . --output-format=github

      - name: Pyright check
        run: pyright .

      - name: Hadolint (Dockerfile lint)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: pods/customer_ops/Dockerfile
          failure-threshold: warning

      - name: Upload diagnostics on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: diagnostics-lint
          path: |
            pods/customer_ops/.ruff_cache/**
            pods/customer_ops/.mypy_cache/**

  unit:
    name: Unit / Guardrails
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: pods/customer_ops
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pods/customer_ops/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.lock.txt ]; then
            pip install -r requirements.lock.txt
          else
            pip install -r requirements.txt
          fi
          pip install pytest pytest-cov

      - name: Run tests with coverage
        env:
          PYTHONPATH: .
          DATABASE_URL: sqlite:///:memory:
          REQUIRE_API_KEY: "false"
          REDIS_URL: ""
          LOG_LEVEL: DEBUG
        run: pytest -q -m "not integration" --cov=api --cov-report=xml --cov-report=term

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./pods/customer_ops/coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload diagnostics on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: diagnostics-unit
          path: |
            pods/customer_ops/.pytest_cache/**
            pods/customer_ops/coverage.xml
            pods/customer_ops/htmlcov/**

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: 'pods/customer_ops'
          ignore-unfixed: true
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Setup Python for Bandit
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run Bandit security scan
        uses: pypa/gh-action-bandit@v1.0.0
        with:
          targets: pods/customer_ops/api
          configfile: pods/customer_ops/.bandit
          exit_zero: false

      - name: Upload diagnostics on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: diagnostics-security
          path: |
            trivy-results.sarif
            bandit-report.txt

  smoke:
    name: Docker Compose Smoke
    runs-on: ubuntu-latest
    needs: [unit, lint, security]
    defaults:
      run:
        working-directory: pods/customer_ops
    steps:
      - uses: actions/checkout@v4

      - name: Ensure jq present (sometimes missing)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compose up
        run: |
          docker compose up --build -d
          docker compose ps

      - name: Wait for /healthz
        run: |
          set -e
          for i in $(seq 1 90); do
            if curl -sf http://localhost:8000/healthz > /dev/null ; then
              echo "healthy"
              exit 0
            fi
            sleep 1
          done
          echo "health check timed out"
          docker compose logs --no-color api
          exit 1

      - name: Exercise endpoints
        run: |
          curl -s http://localhost:8000/healthz | jq .
          curl -s -X POST http://localhost:8000/v1/lead \
            -H 'content-type: application/json' \
            -d '{"name":"CI","phone":"5550001234","details":"smoke"}' | jq .
          curl -s http://localhost:8000/v1/lead | jq .
          curl -s http://localhost:8000/metrics | grep -E 'agent_intent_total' || true

      - name: Exercise endpoints (with API key)
        env:
          API_KEYS: ${{ secrets.API_KEYS || 'public:TEST_KEY' }}
        run: |
          curl -s -X POST http://localhost:8000/v1/lead \
            -H 'content-type: application/json' \
            -H 'x-api-key: TEST_KEY' \
            -d '{"name":"CI-Auth","phone":"5550009999","details":"auth-smoke"}' | jq .

      - name: Compose logs on failure
        if: failure()
        run: docker compose logs --no-color

      - name: Upload diagnostics on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: diagnostics-smoke
          path: |
            pods/customer_ops/docker-compose.yml
            pods/customer_ops/.env

      - name: Compose down
        if: always()
        run: docker compose down -v

  validate-windows:
    name: Windows Dev Loop Validation
    runs-on: windows-latest
    needs: [unit, lint]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Start Docker Desktop (if not already running)
        shell: pwsh
        run: |
          if (!(Get-Process "Docker Desktop" -ErrorAction SilentlyContinue)) {
            Start-Process "C:\Program Files\Docker\Docker\Docker Desktop.exe" -Wait
            Start-Sleep -Seconds 30
          }

      - name: Launch stack
        shell: pwsh
        run: |
          .\makefile.ps1 up
        timeout-minutes: 3

      - name: Health check
        shell: pwsh
        run: |
          .\makefile.ps1 health

      - name: Verify E2E (backup + restore + health)
        shell: pwsh
        run: |
          .\makefile.ps1 verify

      - name: Stop stack
        if: always()
        shell: pwsh
        run: |
          .\makefile.ps1 down
