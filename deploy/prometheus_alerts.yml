# Prometheus Alerting Rules for CustomerOps AI Agent
# Copy to Prometheus config directory or mount in docker-compose

groups:
  - name: customer-ops-model
    interval: 30s
    rules:
      # Model Performance Degradation
      - alert: LeadModelAUCDegraded
        expr: lead_model_auc < 0.65
        for: 30m
        labels:
          severity: warning
          component: prediction
        annotations:
          summary: "Lead prediction model AUC degraded"
          description: "Model AUC is {{ $value | humanizePercentage }}, below threshold of 65% for 30 minutes. Consider retraining."
          runbook: "Check /ops/export/outcomes.csv for data quality. Run manual retrain if needed."
      
      # Critical: Model AUC extremely low
      - alert: LeadModelAUCCritical
        expr: lead_model_auc < 0.55
        for: 10m
        labels:
          severity: critical
          component: prediction
        annotations:
          summary: "Lead prediction model AUC critically low"
          description: "Model AUC is {{ $value | humanizePercentage }}, below 55%. Predictions may be unreliable."
          runbook: "Immediately check model training data and retrain. Consider disabling predictions until fixed."
      
      # Prediction Latency High
      - alert: LeadPredLatencyHigh
        expr: (rate(lead_pred_latency_seconds_sum[5m]) / rate(lead_pred_latency_seconds_count[5m])) > 0.1
        for: 10m
        labels:
          severity: warning
          component: prediction
        annotations:
          summary: "Lead prediction latency high"
          description: "Average prediction latency is {{ $value | humanizeDuration }}, above 100ms threshold for 10 minutes."
          runbook: "Check model size and CPU usage. Consider model optimization or scaling."
      
      # Data Drift Detection
      - alert: LeadModelHighDrift
        expr: lead_model_drift_score > 3.0
        for: 1h
        labels:
          severity: warning
          component: prediction
        annotations:
          summary: "Lead prediction model experiencing high feature drift"
          description: "Model drift score is {{ $value | humanize }}, indicating production features are >3 standard deviations from training distribution."
          runbook: "Check if production data distribution has changed. Consider retraining model with recent data."
      
      # Model Not Loaded
      - alert: LeadModelNotLoaded
        expr: lead_model_version == 0
        for: 5m
        labels:
          severity: critical
          component: prediction
        annotations:
          summary: "Lead prediction model not loaded"
          description: "Model version is 0, indicating model failed to load or is not deployed."
          runbook: "Check API logs for model load errors. Verify model.json exists and is valid."
      
      # Training Data Insufficient
      - alert: LeadModelTrainDataLow
        expr: lead_model_n_train < 100
        for: 1h
        labels:
          severity: warning
          component: prediction
        annotations:
          summary: "Lead model training data insufficient"
          description: "Model trained on only {{ $value }} samples, below recommended 100 minimum."
          runbook: "Continue collecting outcome data. Model may have poor generalization with <100 samples."

  - name: customer-ops-pii
    interval: 30s
    rules:
      # PII Redaction Spike
      - alert: PIIRedactionSpike
        expr: rate(pii_redactions_total[5m]) > 10
        for: 15m
        labels:
          severity: info
          component: memory
        annotations:
          summary: "PII redaction rate spike detected"
          description: "PII redactions increased to {{ $value | humanize }}/sec over 15 minutes."
          runbook: "Normal if traffic increased. Investigate if traffic is flat (may indicate data quality issue)."
      
      # No PII Redactions (Suspicious)
      - alert: PIIRedactionsZero
        expr: rate(pii_redactions_total[1h]) == 0
        for: 2h
        labels:
          severity: warning
          component: memory
        annotations:
          summary: "No PII redactions detected"
          description: "Zero PII redactions in 2 hours. May indicate ENABLE_PII_REDACTION=false or no traffic."
          runbook: "Verify ENABLE_PII_REDACTION=true in config. Check if leads are being created."

  - name: customer-ops-followup
    interval: 30s
    rules:
      # Follow-Up Job Failures
      - alert: FollowUpJobFailureRate
        expr: (rate(followup_jobs_total{result="error"}[10m]) / rate(followup_jobs_total[10m])) > 0.2
        for: 15m
        labels:
          severity: warning
          component: followup
        annotations:
          summary: "Follow-up job failure rate high"
          description: "{{ $value | humanizePercentage }} of follow-up jobs failing over 15 minutes."
          runbook: "Check worker logs for errors. Verify /ops/followup-hook endpoint is accessible."
      
      # Follow-Up Queue Backed Up
      - alert: FollowUpQueueBackedUp
        expr: followup_queue_scheduled > 1000
        for: 1h
        labels:
          severity: warning
          component: followup
        annotations:
          summary: "Follow-up queue backed up"
          description: "{{ $value }} tasks scheduled in queue for 1+ hour. Worker may be down or overloaded."
          runbook: "Check worker status: docker-compose ps worker. Scale workers if needed."
      
      # No Follow-Up Jobs Executing
      - alert: FollowUpJobsStalled
        expr: rate(followup_jobs_total[30m]) == 0
        for: 1h
        labels:
          severity: warning
          component: followup
        annotations:
          summary: "Follow-up jobs not executing"
          description: "No follow-up jobs executed in 1 hour. Worker may be down."
          runbook: "Check worker status: docker-compose logs worker. Restart if needed."

  - name: customer-ops-conversion
    interval: 30s
    rules:
      # Conversion Rate Drop
      - alert: LeadConversionRateDrop
        expr: lead_conversion_rate < 0.05
        for: 6h
        labels:
          severity: warning
          component: analytics
        annotations:
          summary: "Lead conversion rate dropped"
          description: "Conversion rate at {{ $value | humanizePercentage }}, below 5% for 6 hours."
          runbook: "Review recent lead quality. Check if follow-ups are executing. Analyze outcome distribution."
      
      # High Ghost Rate
      - alert: LeadGhostRateHigh
        expr: (rate(lead_outcome_total{outcome="ghosted"}[1h]) / rate(lead_outcome_total[1h])) > 0.5
        for: 3h
        labels:
          severity: warning
          component: analytics
        annotations:
          summary: "Lead ghost rate high"
          description: "{{ $value | humanizePercentage }} of leads ghosting over 3 hours."
          runbook: "Review follow-up timing and messaging. Check pred_prob threshold (may be too low)."

  - name: customer-ops-api
    interval: 30s
    rules:
      # High 5xx Error Rate
      - alert: APIErrorRateHigh
        expr: (rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m])) > 0.05
        for: 10m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "API 5xx error rate high"
          description: "{{ $value | humanizePercentage }} of requests returning 5xx errors."
          runbook: "Check API logs for errors. Verify database and Redis connectivity."
      
      # Request Latency High
      - alert: APILatencyHigh
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2.0
        for: 10m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "API p95 latency high"
          description: "95th percentile latency is {{ $value | humanizeDuration }}, above 2s threshold."
          runbook: "Check database query performance. Review slow log. Consider scaling."
